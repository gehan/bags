<!DOCTYPE html>  <html> <head>   <title>Template.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Collection.html">                 Collection.coffee               </a>                                           <a class="source" href="Model.html">                 Model.coffee               </a>                                           <a class="source" href="Router.html">                 Router.coffee               </a>                                           <a class="source" href="Template.html">                 Template.coffee               </a>                                           <a class="source" href="View.html">                 View.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Template.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Class</span> <span class="nx">to</span> <span class="nx">allow</span> <span class="nx">convenient</span> <span class="nx">rendering</span> <span class="k">of</span> <span class="nx">mustache</span> <span class="nx">templates</span>
<span class="nx">Ideally</span> <span class="nx">used</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nx">mixin</span> <span class="nx">to</span> <span class="nx">add</span> <span class="k">this</span> <span class="nx">ability</span> <span class="nx">to</span> <span class="nx">classes</span> <span class="nx">but</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nx">standalone</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="o">-&gt;</span> <span class="o">\</span>

<span class="k">new</span> <span class="nx">Class</span>
    <span class="nv">TEMPLATES: </span><span class="p">{}</span>
    <span class="nv">refs: </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Loads all current dust templates into memory so they can be rendered
This step is essential if partials are used anywhere are they are expected
to be in the dust cache already when called</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">loadAllTemplates: </span><span class="o">-&gt;</span>
        <span class="nx">@_loadTemplate</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">@TEMPLATES</span>
        <span class="nx">@_loadTemplate</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">$$</span><span class="p">(</span><span class="s">&#39;script[type=text/html]&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;template&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Render dust template</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">renderTemplate: </span><span class="nf">(templateName, data={}, events=null) -&gt;</span>
        <span class="nv">rendered = </span><span class="nx">@_renderDustTemplate</span> <span class="nx">templateName</span><span class="p">,</span> <span class="nx">data</span>
        <span class="nv">els = </span><span class="nx">Elements</span><span class="p">.</span><span class="nx">from</span> <span class="nx">rendered</span>
        <span class="nx">@delegateEvents</span> <span class="nx">els</span><span class="p">,</span> <span class="nx">events</span> <span class="k">if</span> <span class="nx">events</span><span class="o">?</span>

        <span class="k">if</span> <span class="nx">els</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="nx">els</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span>
            <span class="nx">els</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>To make saving references to elements with the template easier if you add the property
ref to the element then this will pull those references back into an object, e.g.
<a href="/somewhere" ref="link">Link</a>
refs = link: <reference to A Element></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getRefs: </span><span class="nf">(els, ref=null) -&gt;</span>
        <span class="nv">refs = </span><span class="p">{}</span>
        <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">from</span> <span class="nx">els</span>
            <span class="nv">elRefName = </span><span class="nx">el</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;ref&#39;</span>
            <span class="k">return</span> <span class="nx">el</span> <span class="k">if</span> <span class="nx">ref</span> <span class="o">and</span> <span class="nx">elRefName</span> <span class="o">==</span> <span class="nx">ref</span>
            <span class="nx">refs</span><span class="p">[</span><span class="nx">elRefName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">el</span> <span class="k">if</span> <span class="nx">elRefName</span>

            <span class="k">for</span> <span class="nx">refEl</span> <span class="k">in</span> <span class="nx">el</span><span class="p">.</span><span class="nx">getElements</span> <span class="s">&quot;*[ref]&quot;</span>
                <span class="nv">refName = </span><span class="nx">refEl</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;ref&#39;</span>
                <span class="k">return</span> <span class="nx">refEl</span> <span class="k">if</span> <span class="nx">ref</span> <span class="o">and</span> <span class="nx">refName</span> <span class="o">==</span> <span class="nx">ref</span>

                <span class="nx">refs</span><span class="p">[</span><span class="nx">refName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">refEl</span>

        <span class="k">return</span> <span class="nx">refs</span>

    <span class="nv">getRef: </span><span class="nf">(el, ref) -&gt;</span> <span class="nx">@getRefs</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">ref</span>

    <span class="nv">_renderDustTemplate: </span><span class="nf">(templateName, data={}) -&gt;</span>
        <span class="nx">@_loadTemplate</span> <span class="nx">templateName</span>
        <span class="nv">data = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">data</span>
        <span class="nv">data.let = </span><span class="nx">data</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">rendered = </span><span class="s">&quot;&quot;</span>
        <span class="nx">dust</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">templateName</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(err, out) -&gt;</span>
            <span class="nv">rendered = </span><span class="nx">out</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nx">rendered</span>

    <span class="nv">_loadTemplate: </span><span class="nf">(templateName) -&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">dust</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">templateName</span><span class="p">]</span><span class="o">?</span>
            <span class="nv">compiled = </span><span class="nx">dust</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">@getTemplate</span><span class="p">(</span><span class="nx">templateName</span><span class="p">),</span> <span class="nx">templateName</span>
            <span class="nx">dust</span><span class="p">.</span><span class="nx">loadSource</span> <span class="nx">compiled</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Tries to find template in the following order of precedence:
1 - Within the current class in TEMPLATES, e.g. when using as mixin
2 - Within a JST script tag on the page
The latter is inserted by using django-mustachejs tags. Compiles and returns
if not already cached
Templates should be stored as follows if using a JST script tag</p>

<script type="text/html" template="template-name">
<div>{{somestuff}}</div>
</script>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getTemplate: </span><span class="nf">(templateName) -&gt;</span>
        <span class="nv">template = </span><span class="nx">@TEMPLATES</span><span class="p">[</span><span class="nx">templateName</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@TEMPLATES</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">template</span> <span class="k">if</span> <span class="nx">template</span><span class="o">?</span>
        <span class="nv">template = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElement</span> <span class="s">&quot;script[template=</span><span class="si">#{</span><span class="nx">templateName</span><span class="si">}</span><span class="s">]&quot;</span>
        <span class="k">return</span> <span class="nx">template</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;html&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">template</span><span class="o">?</span>
        <span class="k">throw</span> <span class="s">&quot;Cannot find template </span><span class="si">#{</span><span class="nx">templateName</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Delegate events from this class</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">delegateEvents: </span><span class="nf">(el, events, preventDefault) -&gt;</span>
        <span class="nv">els = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">from</span> <span class="nx">el</span>
        <span class="k">for</span> <span class="nx">eventKey</span><span class="p">,</span> <span class="nx">fnName</span> <span class="k">of</span> <span class="nx">events</span>
            <span class="nv">boundFn = </span><span class="nf">(fnName, event, target) -&gt;</span>
                <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span> <span class="k">if</span> <span class="nx">preventDefault</span>
                <span class="nx">@</span><span class="p">[</span><span class="nx">fnName</span><span class="p">]</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">target</span>
            <span class="nv">boundFn = </span><span class="nx">boundFn</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">fnName</span>
            <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">els</span>
                <span class="nx">@_addDelegatedEvent</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventKey</span><span class="p">,</span> <span class="nx">boundFn</span>

    <span class="nv">_addDelegatedEvent: </span><span class="nf">(el, eventKey, fn) -&gt;</span>
        <span class="nv">eventKey = </span><span class="nx">eventKey</span><span class="p">.</span><span class="nx">split</span> <span class="s">&quot;:&quot;</span>
        <span class="nv">mtEvent = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">eventKey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">:relay(</span><span class="si">#{</span><span class="nx">eventKey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">)&quot;</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">addEvent</span> <span class="nx">mtEvent</span><span class="p">,</span> <span class="nx">fn</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 