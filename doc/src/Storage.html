<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Storage.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="Collection.html">Collection.coffee</a>
          <a class="source" href="Exceptions.html">Exceptions.coffee</a>
          <a class="source" href="Model.html">Model.coffee</a>
          <a class="source" href="Router.html">Router.coffee</a>
          <a class="source" href="Storage.html">Storage.coffee</a>
          <a class="source" href="Template.html">Template.coffee</a>
          <a class="source" href="View.html">View.coffee</a>
          <a class="source" href="Views.html">Views.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>Storage.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Provides prersistent model storage via AJAX. You can create alternative
Storage classes and implement these in your model to use other methods like
HTML5 local storage.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">define</span> <span class="o">-&gt;</span> <span class="p">\</span>

<span class="kp">new</span> <span class="no">Class</span>
    <span class="no">Implements</span><span class="p">:</span> <span class="o">[</span><span class="no">Events</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-Model_storage'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Model_storage">&#182;</a>
        </div>
        <h1>Model storage</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Storage uses CRUD functions, and this is mapped to it&rsquo;s HTTP counterparts
for this class</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">_crudMap</span><span class="p">:</span>
        <span class="n">create</span><span class="p">:</span> <span class="s1">&#39;post&#39;</span>
        <span class="n">read</span><span class="p">:</span> <span class="s1">&#39;get&#39;</span>
        <span class="n">update</span><span class="p">:</span> <span class="s1">&#39;put&#39;</span>
        <span class="n">delete</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Operations'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Operations">&#182;</a>
        </div>
        <p>To perform storage functions, the <a href="Model.coffee.html">Model</a> class will
call this method and pass simply the operation being performed and any
paramteres as needed. The <a href="Collection.coffee.html">Collection</a> class
also uses the <code>read</code> operation to fetch from the storage.</p>

<h2>Operations</h2>

<ul>
<li>Create &ndash; <code>storage(&lsquo;create&rsquo;, modelData)</code></li>
<li>Read &ndash; <code>storage(&lsquo;read&rsquo;, queryFilters)</code></li>
<li>Update &ndash; <code>storage(&lsquo;update&rsquo;, updatedModelData)</code></li>
<li>Delete &ndash; <code>storage(&lsquo;delete&rsquo;)</code></li>
</ul>

<h2>Handling Operation Completion</h2>

<p>To signal when the operation is complete you have a choice of using
events or using the returned promise.</p>

<ul>
<li><strong>Events</strong></li>
</ul>

<p>Events are fired when during the various stages of the storage request.
  They will be prefixed by the storage operation or <code>options.eventName</code>
  if it&rsquo;s been passed in.</p>

<ul>
<li><p>operation<code>Start</code> &ndash; e.g. readStart</p>

<p>This is fired when the request has been started</p></li>
<li><p>operation<code>Complete</code> &ndash; e.g. createComplete</p>

<p>This is fired when the request has been completeted, and before
 the success/failure events</p></li>
<li><p>operation<code>Success(data)</code> &ndash; e.g. updateSuccess</p>

<p>This is fired when the actual request has succeeded and <code>isSuccess</code>
 returns true to indicate operation success. The parsed data as
 returned by <code>parseResponse</code> is passed through as the first parameter.</p></li>
<li><p>operation<code>Failure(reason)</code> &ndash; e.g. deleteFailure</p>

<p>This is fired when the request itself has failed or <code>isSuccess</code>
 has inidicated failure. In the case of <code>isSuccess</code> failing then the
 failure reason as returned by <code>parseFailResponse</code></p>

<ul>
<li><strong>Promises</strong></li>
</ul></li>
</ul>

<p>Rather than using callbacks the request uses
  <a href="https://github.com/coolaj86/futures">futures.js</a>
  to return a promise, or rather a
  <a href="https://github.com/coolaj86/futures/tree/v2.0/future">Future</a>
  as it is called in this library.</p>

<p>To be notified when the promise is fulfilled, i.e. the request has
  finished in some way, then you can do the following:</p>

<pre><code>    promise = model.storage(operation)
    promise.when (isSuccess, data) &ndash;&gt;
        if isSucces
            # Some code to handle the response
        else
            # Some code to handle the failure
            reason = data
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">storage</span><span class="p">:</span> <span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="no">Future</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;future&#39;</span>
        <span class="n">promise</span> <span class="o">=</span> <span class="kp">new</span> <span class="no">Future</span><span class="p">()</span>

        <span class="nb">method</span> <span class="o">=</span> <span class="vi">@_crudMap</span><span class="o">[</span><span class="n">operation</span><span class="o">]</span>

        <span class="nb">fail</span> <span class="o">=</span> <span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="n">null</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="n">promise</span><span class="o">.</span><span class="n">fulfill</span> <span class="kp">false</span><span class="p">,</span> <span class="n">reason</span>
            <span class="n">fireEvent</span> <span class="s2">&quot;failure&quot;</span><span class="p">,</span> <span class="o">[</span><span class="n">reason</span><span class="o">]</span>

        <span class="n">fireEvent</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="n">eventName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">options</span><span class="o">.</span><span class="n">eventName</span> <span class="ow">or</span> <span class="n">operation</span><span class="si">}#{</span><span class="n">event</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="vi">@fireEvent</span> <span class="n">eventName</span><span class="p">,</span> <span class="n">args</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;read&#39;</span>
            <span class="n">requestData</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">data?</span>
            <span class="n">requestData</span> <span class="o">=</span> <span class="n">model</span><span class="p">:</span> <span class="no">JSON</span><span class="o">.</span><span class="n">encode</span> <span class="n">data</span>
        <span class="k">else</span>
            <span class="n">requestData</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">promise</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="kp">new</span> <span class="no">Request</span><span class="o">.</span><span class="n">JSON</span>
            <span class="n">url</span><span class="p">:</span> <span class="vi">@_getUrl</span> <span class="n">operation</span>
            <span class="nb">method</span><span class="p">:</span> <span class="nb">method</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">requestData</span>

            <span class="n">onRequest</span><span class="p">:</span> <span class="o">=&gt;</span> <span class="n">fireEvent</span> <span class="s2">&quot;start&quot;</span>
            <span class="n">onComplete</span><span class="p">:</span> <span class="o">=&gt;</span> <span class="n">fireEvent</span> <span class="s2">&quot;complete&quot;</span>
            <span class="n">onFailure</span><span class="p">:</span> <span class="p">(</span><span class="n">xhr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">fail</span><span class="p">()</span>
            <span class="n">onSuccess</span><span class="p">:</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">if</span> <span class="vi">@isSuccess</span> <span class="n">response</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="vi">@parseResponse</span> <span class="n">response</span>
                    <span class="n">promise</span><span class="o">.</span><span class="n">fulfill</span> <span class="kp">true</span><span class="p">,</span> <span class="n">data</span>
                    <span class="n">fireEvent</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="o">[</span><span class="n">data</span><span class="o">]</span>
                <span class="k">else</span>
                    <span class="n">reason</span> <span class="o">=</span> <span class="vi">@parseFailResponse</span> <span class="n">response</span>
                    <span class="nb">fail</span> <span class="n">reason</span>
        <span class="o">.</span><span class="n">send</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">promise</span></pre></div>
      </td>
    </tr>
    <tr id='section-Response_parsing'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Response_parsing">&#182;</a>
        </div>
        <h2>Response parsing</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>If the request itself has succeeded then this function is called with
the response to determine if the operation has indeed succeeded.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">isSuccess</span><span class="p">:</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">success</span> <span class="n">is</span> <span class="kp">true</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>If the operation has succeeded then this is called to extract the data
returned in the response</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">parseResponse</span><span class="p">:</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">data</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>If the operation has failed then this is called to extract the reason</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">parseFailResponse</span><span class="p">:</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">error</span></pre></div>
      </td>
    </tr>
    <tr id='section-Determining_the_correct_URL'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Determining_the_correct_URL">&#182;</a>
        </div>
        <h2>Determining the correct URL</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>This determines the correct URL for the given operation. The base URL
is expected either be <code>@url</code> in the class or in <code>@collection.url</code> if
the model is part of a collection.</p>

<p>For the various operations the url will be</p>

<ul>
<li>create: <code>url</code></li>
<li>read: <code>url/id</code></li>
<li>update: <code>url/id</code></li>
<li>delete: <code>url/id</code></li>
</ul>

<p>If this is a collection then it will be</p>

<ul>
<li>read: <code>url</code></li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">_getUrl</span><span class="p">:</span> <span class="p">(</span><span class="n">operation</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="vi">@url</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url?</span> <span class="ow">and</span> <span class="vi">@collection</span><span class="p">?</span>
            <span class="n">url</span> <span class="o">=</span> <span class="vi">@collection</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url?</span>
            <span class="kp">throw</span> <span class="kp">new</span> <span class="no">Error</span> <span class="s2">&quot;No url can be found&quot;</span>

        <span class="k">if</span> <span class="vi">@isCollection</span>
            <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">operation</span> <span class="k">in</span> <span class="o">[</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="o">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="vi">@id</span><span class="p">?</span>
                <span class="kp">throw</span> <span class="kp">new</span> <span class="no">Error</span> <span class="s2">&quot;&quot;&quot;Model doesn&#39;t have an id, cannot perform</span>

<span class="s2"># DIVIDER</span>


<span class="s2">            &quot;</span><span class="c1">#{url}/#{@id}&quot;</span>
        <span class="k">else</span>
            <span class="n">url</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>{operation}&ldquo;&rdquo;&ldquo;</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
