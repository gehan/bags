<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Model.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="Collection.html">Collection.coffee</a>
          <a class="source" href="Events.html">Events.coffee</a>
          <a class="source" href="Exceptions.html">Exceptions.coffee</a>
          <a class="source" href="Model.html">Model.coffee</a>
          <a class="source" href="Router.html">Router.coffee</a>
          <a class="source" href="Storage.html">Storage.coffee</a>
          <a class="source" href="Template.html">Template.coffee</a>
          <a class="source" href="View.html">View.coffee</a>
          <a class="source" href="Views.html">Views.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>Model.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Provides a simple model class. The key benefit is separating models from
your view code, along with concerns like persistance, and interacting
through the events fired when a model is updated to handle rendering.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="sb">`define([&#39;require&#39;, &#39;bags/Storage&#39;, &#39;bags/Collection&#39;, &#39;bags/Exceptions&#39;,</span>
<span class="sb">    &#39;bags/Events&#39;], function(require, Storage, Collection, Exceptions, Events)</span>
<span class="sb">    {`</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Provides Collection mutator to allow class level access to the model&rsquo;s
collection</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Class</span><span class="o">.</span><span class="n">Mutators</span><span class="o">.</span><span class="n">Collection</span> <span class="o">=</span> <span class="p">(</span><span class="n">collectionDef</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="err">@</span><span class="vg">$collection</span>
        <span class="n">collectionDef</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">merge</span> <span class="p">{},</span> <span class="err">@</span><span class="vg">$collection</span><span class="p">,</span> <span class="n">collectionDef</span>
    <span class="vi">@extend</span>
        <span class="vg">$collection</span><span class="p">:</span> <span class="n">collectionDef</span>
        <span class="n">getCollection</span><span class="p">:</span> <span class="o">-&gt;</span>
            <span class="n">copy</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">clone</span> <span class="n">collectionDef</span>
            <span class="n">col</span> <span class="o">=</span> <span class="kp">new</span> <span class="n">copy</span><span class="o">.</span><span class="n">class</span> <span class="o">[]</span><span class="p">,</span>
                <span class="n">url</span><span class="p">:</span> <span class="vi">@prototype</span><span class="o">.</span><span class="n">url</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="n">of</span> <span class="n">copy</span> <span class="k">when</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;$collection&#39;</span>
                <span class="n">col</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">col</span>

<span class="vg">$extends</span> <span class="o">=</span> <span class="no">Class</span><span class="o">.</span><span class="n">Mutators</span><span class="o">.</span><span class="n">Extends</span>
<span class="no">Class</span><span class="o">.</span><span class="n">Mutators</span><span class="o">.</span><span class="n">Extends</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="vg">$collection</span>
        <span class="no">Class</span><span class="o">.</span><span class="n">Mutators</span><span class="o">.</span><span class="n">Collection</span><span class="o">.</span><span class="n">apply</span> <span class="n">this</span><span class="p">,</span> <span class="o">[</span><span class="n">parent</span><span class="o">.</span><span class="vg">$collection</span><span class="o">]</span>

    <span class="vg">$extends</span><span class="o">.</span><span class="n">apply</span> <span class="n">this</span><span class="p">,</span> <span class="n">arguments</span>

<span class="no">Model</span> <span class="o">=</span> <span class="kp">new</span> <span class="no">Class</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Uses <a href="Storage.coffee.html">Storage</a> for model storage</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="no">Implements</span><span class="p">:</span> <span class="o">[</span><span class="no">Events</span><span class="p">,</span> <span class="no">Options</span><span class="p">,</span> <span class="no">Storage</span><span class="o">]</span>

    <span class="no">Collection</span><span class="p">:</span>
        <span class="n">class</span><span class="p">:</span> <span class="no">Collection</span></pre></div>
      </td>
    </tr>
    <tr id='section-Specfying_field_classes_(optional)'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Specfying_field_classes_(optional)">&#182;</a>
        </div>
        <h2>Specfying field classes (optional)</h2>

<p>Specificying fields is not required, as a model will accept whatever
fields you give it, however they will just be strings or numbers as
the case may be.</p>

<p>If you wish to use different classes for fields then you can define them
here. If defined for a field then when a value is set, the constructor
will be called with that value.</p>

<p>e.g. if</p>

<pre><code>fields:
    someField: MyObject
</code></pre>

<p>then</p>

<pre><code>model.set &lsquo;someField&rsquo;, id: 1, text: &lsquo;Hello there&rsquo;
=&gt; model.someField = new MyObject(id: 1, text: &lsquo;Hello there&rsquo;)
</code></pre>

<p>Values can be the class object directly, a function that returns a
class or a string which will be queries as window[string]</p>

<p>e.g.</p>

<pre><code>fields:
    createdDate: Date
    someObj: &ldquo;ObjectClass&rdquo;
    someModel: &ndash;&gt; SomeModel
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">fields</span><span class="p">:</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Field_defaults'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Field_defaults">&#182;</a>
        </div>
        <h2>Field defaults</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Default values for fields can be set also, and do not require a field
definition above.</p>

<p>e.g.</p>

<pre><code>defaults:
    text: &ldquo;Hello there&rdquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">defaults</span><span class="p">:</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Custom_accessors'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Custom_accessors">&#182;</a>
        </div>
        <h2>Custom accessors</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Â For each field in the model you can define custom get/set methods</p>

<p>e.g.</p>

<pre><code>properties:
    someField:
        get: &ndash;&gt;
            return this.get(&lsquo;firstName&rsquo;) + &lsquo; &rsquo; this.get(&lsquo;lastName&rsquo;)
        set: (value) &ndash;&gt;
            parts = value.split &lsquo; &rsquo;
            @_set
                firstName: parts[0]
                lastName: parts[1]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">properties</span><span class="p">:</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Model_validation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Model_validation">&#182;</a>
        </div>
        <h2>Model validation</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>When attempting to create or update a model validation can be performed
for each field if desired. Return true to pass validation otherwise
return false or a string for an error message.</p>

<p>e.g.</p>

<pre><code>validators:
    email: (value) &ndash;&gt;
        if value.indexOf &lsquo;@&rsquo; &lt; 0
            return &lsquo;Invalid email address&rsquo;
        else
            return true
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">validators</span><span class="p">:</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Model_id'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Model_id">&#182;</a>
        </div>
        <h2>Model id</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>When a model&rsquo;s id field has been set then this field is populated. Setting
this field will not change it and will probably break your model</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nb">id</span><span class="p">:</span> <span class="n">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Some database systems use a different id field to <code>id</code>. If this is the case
then override it here and that field will be used to give the magic <code>id</code>
field
here</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">idField</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Using_&lt;a_href=&quot;Collection.coffee.html&quot;&gt;Collection&lt;/a&gt;_classes_as_fields'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Using_&lt;a_href=&quot;Collection.coffee.html&quot;&gt;Collection&lt;/a&gt;_classes_as_fields">&#182;</a>
        </div>
        <h2>Using <a href="Collection.coffee.html">Collection</a> classes as fields</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>If you set a field as a Collection then it is handled slightly
differently. As well as the field being set as a Collection instance, the
collection will be added to the <code>@collections</code> object and a
<code>addCollection [key, collection]</code> event is fired.</p>

<p>e.g. if</p>

<pre><code>fields:
    myCollection: Collection
</code></pre>

<p>then</p>

<pre><code>model.set &lsquo;myCollection&rsquo;, [{model}, {model}]
=&gt; model.collections.myCollection = collection
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">collections</span><span class="p">:</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>If using default <code>Storage</code> class then you can set the server url here. If
the Model was create via a Collection then @url will be read from that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">url</span><span class="p">:</span> <span class="n">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-Using_the_Model_class'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Using_the_Model_class">&#182;</a>
        </div>
        <h1>Using the Model class</h1>

<p>When instantiating a model often you will be passing it&rsquo;s field values to as
the <code>attributes</code> object, typically after a json response from the server.</p>

<p>e.g.</p>

<pre><code>m = new Model
    id: 5
    text: &ldquo;Hello there everyone&rdquo;
    createdDate: &ldquo;2012/05/15&rdquo;
</code></pre>

<p>Usually a model would be part of a collection and generally instatiated from
there but if that&rsquo;s not the case then you pass in the collection it&rsquo;s part of
directly, and the server resource url too for persistance. Generally the url
would be taken from the associated collection.</p>

<p>When a model is first instatiated no events are fired.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">initialize</span><span class="p">:</span> <span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="o">[</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="o">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">?</span>
                <span class="err">@</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
                <span class="n">delete</span> <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
        <span class="vi">@setOptions</span> <span class="n">options</span>
        <span class="vi">@_setInitial</span> <span class="n">attributes</span>
        <span class="err">@</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Simple has, get methods</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">has</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="vi">@_attributes</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">?</span>

    <span class="n">get</span><span class="p">:</span> <span class="p">((</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">_value</span> <span class="o">=</span> <span class="vi">@_cloneField</span> <span class="n">key</span>

        <span class="k">if</span> <span class="vi">@properties</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="ow">and</span> <span class="vi">@properties</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">get</span>
            <span class="vi">@properties</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">get</span><span class="o">.</span><span class="n">call</span> <span class="n">this</span><span class="p">,</span> <span class="n">_value</span>
        <span class="k">else</span>
            <span class="n">_value</span>

    <span class="p">)</span><span class="o">.</span><span class="n">overloadGetter</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Set can accept <code>key</code>, <code>value</code> arguments to set one field&rsquo;s value, or it
can accept a key/value object to set multiple at once.</p>

<p>If any fields are defined then the value will be passed to the field class.
If the value is an Collection then it is also added to <code>@collection</code>.</p>

<p>For each field that&rsquo;s updated 2 <code>change</code> events are fired to notify any
listeners, unless <code>silent: true</code> is passed through as an option.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">set</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>

        <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">options</span>
        <span class="k">else</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">attrs</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">try</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="n">of</span> <span class="n">attrs</span>
                <span class="n">_attrs</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@_set</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">options</span>
        <span class="kp">catch</span> <span class="n">error</span>
            <span class="k">if</span> <span class="n">instanceOf</span> <span class="n">error</span><span class="p">,</span> <span class="no">Exceptions</span><span class="o">.</span><span class="n">Validation</span>
                <span class="k">return</span> <span class="kp">false</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="n">of</span> <span class="n">_attrs</span>
            <span class="k">if</span> <span class="vi">@_isCollection</span> <span class="n">key</span>
                <span class="vi">@_addCollection</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">options</span>

            <span class="n">curVal</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">encode</span> <span class="vi">@_attributes</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
            <span class="n">newVal</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">encode</span> <span class="n">value</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="n">curVal</span> <span class="n">isnt</span> <span class="n">newVal</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="vi">@_dirtyFields</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">?</span> <span class="ow">and</span> <span class="n">changed</span>
                <span class="vi">@_dirtyFields</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@_attributes</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>

            <span class="vi">@_attributes</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="vi">@idField</span>
                <span class="vi">@id</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">changed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>
                <span class="vi">@fireEvent</span> <span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="o">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">]</span>
                <span class="vi">@fireEvent</span> <span class="s2">&quot;change:</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">[</span><span class="n">value</span><span class="o">]</span>

        <span class="k">return</span> <span class="kp">true</span>

    <span class="n">_set</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="vi">@_isCollection</span> <span class="n">key</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="vi">@_makeCollection</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>
        <span class="k">else</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="vi">@_makeValue</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

        <span class="k">if</span> <span class="vi">@properties</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="ow">and</span> <span class="vi">@properties</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">set?</span>
            <span class="vi">@properties</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">set</span><span class="o">.</span><span class="n">call</span> <span class="n">this</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">value</span>
        <span class="k">else</span>
            <span class="vi">@_validateField</span> <span class="n">key</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">options</span>
            <span class="n">_value</span>

    <span class="n">_validateField</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="vi">@validators</span> <span class="ow">and</span> <span class="vi">@validators</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">?</span>
            <span class="n">result</span> <span class="o">=</span> <span class="vi">@validators</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">call</span> <span class="n">this</span><span class="p">,</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">result</span> <span class="n">isnt</span> <span class="kp">true</span>
                <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>
                    <span class="vi">@fireEvent</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="o">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">result</span><span class="o">]</span>
                    <span class="vi">@fireEvent</span> <span class="s2">&quot;error:</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">[</span><span class="n">value</span><span class="p">,</span> <span class="n">result</span><span class="o">]</span>
                <span class="kp">throw</span> <span class="kp">new</span> <span class="no">Exceptions</span><span class="o">.</span><span class="n">Validation</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">result</span>
        <span class="k">return</span> <span class="kp">true</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Whether model is already stored or new</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">isNew</span><span class="p">:</span> <span class="o">-&gt;</span> <span class="ow">not</span> <span class="vi">@id</span><span class="p">?</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Whether a model has unsaved changes or not</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">isDirty</span><span class="p">:</span> <span class="o">-&gt;</span>
        <span class="no">Object</span><span class="o">.</span><span class="n">getLength</span><span class="p">(</span><span class="vi">@_dirtyFields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Clear unsaved changes and restores model to last saved state</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">clearChanges</span><span class="p">:</span> <span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="n">silent</span><span class="p">:</span> <span class="kp">true</span><span class="p">})</span> <span class="o">-&gt;</span>
        <span class="vi">@set</span> <span class="vi">@_dirtyFields</span><span class="p">,</span> <span class="n">options</span>
        <span class="vi">@_clearDirtyFields</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-Serialisation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Serialisation">&#182;</a>
        </div>
        <h2>Serialisation</h2>

<p>This method will return a represenation of the model in a format that
is suitable for JSON encoding. This is used to store the model but is
also very handy for rendering the model in templates etc.</p>

<p>For string or numbers their values do not need any conversion, but for
any custom classes then serialisation of these can be handled in two ways</p>

<ul>
<li><strong>Ensure object has <code>toJSON</code> method</strong></li>
</ul>

<p>Much like Model and Collection have a <code>toJSON</code>, any custom classes you
  use for fields can simply have a <code>toJSON</code> method</p>

<ul>
<li><strong>Specify a custom JSON method</strong></li>
</ul>

<p>Alternatively for a given field <code>myField</code> you can create a method on
  the class called <code>jsonMyField</code> which will be called to serialise the
  data</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">toJSON</span><span class="p">:</span> <span class="o">-&gt;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="n">of</span> <span class="vi">@_attributes</span>
            <span class="n">attrs</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@_jsonKeyValue</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">attrs</span></pre></div>
      </td>
    </tr>
    <tr id='section-Model_storage'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Model_storage">&#182;</a>
        </div>
        <h1>Model storage</h1>

<p>The actual model storage has been abstracted out to
<a href="Storage.coffee.html">Storage</a>
which should be read to learn about the various events fired during each
operation and as well as how to handle to returned promise.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Fetches the model from the server, useful if you just have the id
of the model.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">fetch</span><span class="p">:</span> <span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="vi">@isNew</span><span class="p">()</span>

        <span class="n">storageOptions</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">merge</span> <span class="p">{</span><span class="n">eventName</span><span class="p">:</span> <span class="s1">&#39;fetch&#39;</span><span class="p">},</span> <span class="n">options</span>
        <span class="n">promise</span> <span class="o">=</span> <span class="vi">@storage</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">storageOptions</span>
        <span class="n">promise</span><span class="o">.</span><span class="n">when</span> <span class="p">(</span><span class="n">isSuccess</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="n">isSuccess</span>
                <span class="vi">@set</span> <span class="n">data</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="kp">true</span>
                <span class="vi">@_clearDirtyFields</span><span class="p">()</span>
                <span class="vi">@fireEvent</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="o">[</span><span class="kp">true</span><span class="o">]</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Saves the model. Can be called simply as <code>save()</code> to store the model in
its current state or you can specificy only certain values to update and
call <code>save(field, value)</code> or <code>save(fieldValueObject</code> in the same way you
call <code>set</code></p>

<p>By default if any values are specified then when the save operation has
completed then the standard set <code>change</code> events are fired. However if
<code>options.dontWait=true</code> then the <code>change</code> events are fired immediately.
This is for if you are assuming request success rather than waiting for
it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">save</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="no">ModelClass</span> <span class="o">=</span> <span class="err">@</span><span class="vg">$constructor</span>
        <span class="k">if</span> <span class="n">key?</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">attrs</span><span class="o">[</span><span class="vi">@idField</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@id</span> <span class="k">if</span> <span class="ow">not</span> <span class="vi">@isNew</span><span class="p">()</span>
            <span class="n">toUpdate</span> <span class="o">=</span> <span class="kp">new</span> <span class="no">ModelClass</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">ignoreDefaults</span><span class="p">:</span> <span class="kp">true</span>
            <span class="n">toUpdate</span><span class="o">.</span><span class="n">set</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">key?</span>
        <span class="k">else</span>
            <span class="n">toUpdate</span> <span class="o">=</span> <span class="kp">new</span> <span class="no">ModelClass</span> <span class="vi">@toJSON</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">toUpdate</span><span class="o">.</span><span class="n">toJSON</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">setAttrFn</span> <span class="o">=</span> <span class="o">=&gt;</span>
            <span class="vi">@set</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">options</span> <span class="k">if</span> <span class="n">key?</span>
            <span class="vi">@_clearDirtyFields</span><span class="p">()</span>
        <span class="n">setAttrFn</span><span class="p">()</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dontWait</span>

        <span class="n">storageMethod</span> <span class="o">=</span> <span class="k">if</span> <span class="vi">@isNew</span><span class="p">()</span> <span class="k">then</span> <span class="s2">&quot;create&quot;</span> <span class="k">else</span> <span class="s2">&quot;update&quot;</span>
        <span class="n">storageOptions</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">merge</span> <span class="p">{</span><span class="n">eventName</span><span class="p">:</span> <span class="s1">&#39;save&#39;</span><span class="p">},</span> <span class="n">options</span>
        <span class="n">promise</span> <span class="o">=</span> <span class="vi">@storage</span> <span class="n">storageMethod</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">storageOptions</span>
        <span class="n">promise</span><span class="o">.</span><span class="n">when</span> <span class="p">(</span><span class="n">isSuccess</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="n">isSuccess</span>
                <span class="n">setAttrFn</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">dontWait</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="vi">@set</span> <span class="n">model</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="kp">true</span>
                <span class="vi">@_clearDirtyFields</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>Deletes the model from storage</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">destroy</span><span class="p">:</span> <span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="n">fireEvent</span> <span class="o">=</span> <span class="o">=&gt;</span>
            <span class="vi">@fireEvent</span> <span class="s1">&#39;destroy&#39;</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>

        <span class="k">if</span> <span class="vi">@isNew</span><span class="p">()</span>
            <span class="n">fireEvent</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dontWait</span>
            <span class="n">fireEvent</span><span class="p">()</span>

        <span class="n">storageOptions</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">merge</span> <span class="p">{</span><span class="n">eventName</span><span class="p">:</span> <span class="s1">&#39;destroy&#39;</span><span class="p">},</span> <span class="n">options</span>
        <span class="n">promise</span> <span class="o">=</span> <span class="vi">@storage</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">storageOptions</span>
        <span class="n">promise</span><span class="o">.</span><span class="n">when</span> <span class="p">(</span><span class="n">isSuccess</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="n">isSuccess</span>
                <span class="n">fireEvent</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">dontWait</span></pre></div>
      </td>
    </tr>
    <tr id='section-Private_methods'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Private_methods">&#182;</a>
        </div>
        <h1>Private methods</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">_attributes</span><span class="p">:</span> <span class="p">{}</span>
    <span class="n">_dirtyFields</span><span class="p">:</span> <span class="p">{}</span>

    <span class="n">_makeValue</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">type</span> <span class="o">=</span> <span class="vi">@_getType</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="p">(</span><span class="vi">@_makeValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">type</span>
            <span class="n">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">type</span> <span class="n">is</span> <span class="nb">String</span>
            <span class="nb">String</span> <span class="n">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">type</span> <span class="n">is</span> <span class="no">Number</span>
            <span class="no">Number</span><span class="o">.</span><span class="n">from</span> <span class="n">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">type</span> <span class="n">is</span> <span class="no">Date</span>
            <span class="no">Date</span><span class="o">.</span><span class="n">parse</span> <span class="n">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">type</span><span class="o">.</span><span class="n">prototype</span> <span class="ow">and</span> <span class="n">type</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">isModel</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">val</span> <span class="o">=</span> <span class="kp">new</span> <span class="n">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">val</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="err">@</span>
            <span class="n">val</span>
        <span class="k">else</span>
            <span class="kp">new</span> <span class="n">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">_getType</span><span class="p">:</span> <span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">type</span> <span class="o">=</span> <span class="vi">@fields</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span>
            <span class="n">type</span><span class="p">()</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span>  <span class="s2">&quot;string&quot;</span>
            <span class="n">window</span><span class="o">[</span><span class="n">type</span><span class="o">]</span>
        <span class="k">else</span>
            <span class="n">type</span>

    <span class="n">_isCollection</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">type</span> <span class="o">=</span> <span class="vi">@_getType</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">type?</span> <span class="ow">and</span> <span class="n">type</span><span class="o">.</span><span class="n">prototype</span> <span class="ow">and</span> <span class="n">type</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">isCollection</span>

    <span class="n">_isModel</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">type</span> <span class="o">=</span> <span class="vi">@_getType</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">type?</span> <span class="ow">and</span> <span class="n">type</span><span class="o">.</span><span class="n">prototype</span> <span class="ow">and</span> <span class="n">type</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">isModel</span>

    <span class="n">_makeCollection</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">collectionClass</span> <span class="o">=</span> <span class="vi">@_getType</span> <span class="n">key</span>
        <span class="kp">new</span> <span class="n">collectionClass</span> <span class="n">value</span><span class="p">,</span> <span class="n">parentModel</span><span class="p">:</span> <span class="n">this</span>

    <span class="n">_addCollection</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="vi">@collections</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="vi">@fireEvent</span> <span class="s1">&#39;addCollection&#39;</span><span class="p">,</span> <span class="o">[</span><span class="n">key</span><span class="p">,</span> <span class="n">collection</span><span class="o">]</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>

    <span class="n">_setInitial</span><span class="p">:</span> <span class="p">(</span><span class="n">attributes</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="k">unless</span> <span class="vi">@options</span><span class="o">.</span><span class="n">ignoreDefaults</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="no">Object</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="vi">@defaults</span><span class="p">)),</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="vi">@_getDefault</span> <span class="n">key</span>
        <span class="k">else</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Merge defaults into attributes like this to
keep references intact</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">attrKeys</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">keys</span> <span class="n">attributes</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">filter</span> <span class="n">defaults</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">key</span> <span class="ow">not</span> <span class="k">in</span> <span class="n">attrKeys</span>

        <span class="no">Object</span><span class="o">.</span><span class="n">merge</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">defaults</span>
        <span class="vi">@set</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="kp">true</span>
        <span class="vi">@_clearDirtyFields</span><span class="p">()</span>

    <span class="n">_cloneField</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="vi">@_attributes</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
        <span class="n">type</span> <span class="o">=</span> <span class="vi">@_getType</span> <span class="n">key</span>
        <span class="n">jsonValue</span> <span class="o">=</span> <span class="vi">@_jsonKeyValue</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="n">jsonValue</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">jsonValue</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">clone</span> <span class="n">jsonValue</span>
        <span class="k">else</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="n">jsonValue</span>

        <span class="k">if</span> <span class="n">_value</span> <span class="ow">and</span> <span class="vi">@_isCollection</span> <span class="n">key</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="kp">new</span> <span class="n">type</span> <span class="n">_value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">_value</span> <span class="ow">and</span> <span class="vi">@_isModel</span> <span class="n">key</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="kp">new</span> <span class="n">type</span> <span class="n">_value</span>
            <span class="n">_value</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">this</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span> <span class="n">_value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">constructor</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="kp">new</span> <span class="n">value</span><span class="o">.</span><span class="n">constructor</span> <span class="n">_value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="n">_value</span> <span class="o">=</span> <span class="n">_value</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">orig</span> <span class="o">=</span> <span class="n">value</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
                <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span>
                    <span class="no">Date</span><span class="o">.</span><span class="n">parse</span> <span class="n">item</span>
                <span class="k">else</span> <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="ow">and</span> <span class="n">orig</span><span class="o">.</span><span class="n">constructor</span>
                    <span class="kp">new</span> <span class="n">orig</span><span class="o">.</span><span class="n">constructor</span> <span class="n">item</span>
                <span class="k">else</span>
                    <span class="n">item</span>
        <span class="n">_value</span>

    <span class="n">_getDefault</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">def</span> <span class="o">=</span> <span class="vi">@defaults</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">def</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
            <span class="k">def</span><span class="o">.</span><span class="n">call</span> <span class="err">@</span>
        <span class="k">else</span>
            <span class="k">def</span>

    <span class="nf">_isSuccess</span><span class="p">:</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">success</span> <span class="n">is</span> <span class="kp">true</span>

    <span class="n">_jsonKeyValue</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">jsonFn</span> <span class="o">=</span> <span class="s2">&quot;json</span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="err">@</span><span class="o">[</span><span class="n">jsonFn</span><span class="o">]</span><span class="p">?</span>
            <span class="err">@</span><span class="o">[</span><span class="n">jsonFn</span><span class="o">]</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="p">(</span><span class="vi">@_jsonValue</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="k">in</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="vi">@_jsonValue</span> <span class="n">value</span>

    <span class="n">_jsonValue</span><span class="p">:</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">instanceOf</span> <span class="n">value</span><span class="p">,</span> <span class="no">Date</span>
            <span class="n">value</span><span class="o">.</span><span class="n">format</span> <span class="s2">&quot;%Y-%m-%dT%H:%M:%S.%LZ&quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">toJSON</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
            <span class="n">value</span><span class="o">.</span><span class="n">toJSON</span><span class="p">()</span>
        <span class="k">else</span>
            <span class="n">value</span>

    <span class="n">_clearDirtyFields</span><span class="p">:</span> <span class="o">-&gt;</span>
        <span class="vi">@_dirtyFields</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">isModel</span><span class="p">:</span> <span class="kp">true</span>

<span class="k">return</span> <span class="no">Model</span>
<span class="sb">`});`</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
