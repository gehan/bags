<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Model.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="Collection.html">Collection.coffee</a>
          <a class="source" href="Exceptions.html">Exceptions.coffee</a>
          <a class="source" href="Model.html">Model.coffee</a>
          <a class="source" href="Router.html">Router.coffee</a>
          <a class="source" href="Storage.html">Storage.coffee</a>
          <a class="source" href="Template.html">Template.coffee</a>
          <a class="source" href="View.html">View.coffee</a>
          <a class="source" href="Views.html">Views.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>Model.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Provides a simple model class. The key benefit is separating models from
your view code, along with concerns like persistance, and interacting
through the events fired when a model is updated to handle rendering.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="o">`</span><span class="nx">define</span><span class="p">([</span><span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;bags/Storage&#39;</span><span class="p">,</span> <span class="s1">&#39;bags/Collection&#39;</span><span class="p">,</span> <span class="s1">&#39;bags/Exceptions&#39;</span><span class="p">],</span>
<span class="nx">function</span><span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">Storage</span><span class="p">,</span> <span class="nx">Collection</span><span class="p">,</span> <span class="nx">Exceptions</span><span class="p">)</span> <span class="p">{</span><span class="o">`</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Provides Collection mutator to allow class level access to the model&rsquo;s
collection</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">Class.Mutators.Collection = </span><span class="nf">(collectionDef) -&gt;</span>
    <span class="k">if</span> <span class="nx">@$collection</span>
        <span class="nv">collectionDef = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">merge</span> <span class="p">{},</span> <span class="nx">@$collection</span><span class="p">,</span> <span class="nx">collectionDef</span>
    <span class="nx">@extend</span>
        <span class="nv">$collection: </span><span class="nx">collectionDef</span>
        <span class="nv">getCollection: </span><span class="o">-&gt;</span>
            <span class="nv">copy = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">collectionDef</span>
            <span class="nv">col = </span><span class="k">new</span> <span class="nx">copy</span><span class="p">.</span><span class="k">class</span> <span class="p">[],</span>
                <span class="nv">url: </span><span class="nx">@prototype</span><span class="p">.</span><span class="nx">url</span>
            <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">copy</span> <span class="k">when</span> <span class="nx">value</span> <span class="o">!=</span> <span class="s1">&#39;$collection&#39;</span>
                <span class="nx">col</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
            <span class="k">return</span> <span class="nx">col</span>

<span class="nv">$extends = </span><span class="nx">Class</span><span class="p">.</span><span class="nx">Mutators</span><span class="p">.</span><span class="nx">Extends</span>
<span class="nv">Class.Mutators.Extends = </span><span class="nf">(parent) -&gt;</span>
    <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$collection</span>
        <span class="nx">Class</span><span class="p">.</span><span class="nx">Mutators</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">parent</span><span class="p">.</span><span class="nx">$collection</span><span class="p">]</span>

    <span class="nx">$extends</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span>

<span class="nv">Model = </span><span class="k">new</span> <span class="nx">Class</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Uses <a href="Storage.coffee.html">Storage</a> for model storage</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">Implements: </span><span class="p">[</span><span class="nx">Events</span><span class="p">,</span> <span class="nx">Options</span><span class="p">,</span> <span class="nx">Storage</span><span class="p">]</span>

    <span class="nv">Collection:</span>
        <span class="k">class</span><span class="o">:</span> <span class="nx">Collection</span></pre></div>
      </td>
    </tr>
    <tr id='section-Specfying_field_classes_(optional)'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Specfying_field_classes_(optional)">&#182;</a>
        </div>
        <h2>Specfying field classes (optional)</h2>

<p>Specificying fields is not required, as a model will accept whatever
fields you give it, however they will just be strings or numbers as
the case may be.</p>

<p>If you wish to use different classes for fields then you can define them
here. If defined for a field then when a value is set, the constructor
will be called with that value.</p>

<p>e.g. if</p>

<pre><code>fields:
    someField: MyObject
</code></pre>

<p>then</p>

<pre><code>model.set &lsquo;someField&rsquo;, id: 1, text: &lsquo;Hello there&rsquo;
=&gt; model.someField = new MyObject(id: 1, text: &lsquo;Hello there&rsquo;)
</code></pre>

<p>Values can be the class object directly, a function that returns a
class or a string which will be queries as window[string]</p>

<p>e.g.</p>

<pre><code>fields:
    createdDate: Date
    someObj: &ldquo;ObjectClass&rdquo;
    someModel: &ndash;&gt; SomeModel
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">fields: </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Field_defaults'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Field_defaults">&#182;</a>
        </div>
        <h2>Field defaults</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Default values for fields can be set also, and do not require a field
definition above.</p>

<p>e.g.</p>

<pre><code>defaults:
    text: &ldquo;Hello there&rdquo;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">defaults: </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Custom_accessors'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Custom_accessors">&#182;</a>
        </div>
        <h2>Custom accessors</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Â For each field in the model you can define custom get/set methods</p>

<p>e.g.</p>

<pre><code>properties:
    someField:
        get: &ndash;&gt;
            return this.get(&lsquo;firstName&rsquo;) + &lsquo; &rsquo; this.get(&lsquo;lastName&rsquo;)
        set: (value) &ndash;&gt;
            parts = value.split &lsquo; &rsquo;
            @_set
                firstName: parts[0]
                lastName: parts[1]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">properties: </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Model_validation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Model_validation">&#182;</a>
        </div>
        <h2>Model validation</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>When attempting to create or update a model validation can be performed
for each field if desired. Return true to pass validation otherwise
return false or a string for an error message.</p>

<p>e.g.</p>

<pre><code>validators:
    email: (value) &ndash;&gt;
        if value.indexOf &lsquo;@&rsquo; &lt; 0
            return &lsquo;Invalid email address&rsquo;
        else
            return true
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">validators: </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Model_id'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Model_id">&#182;</a>
        </div>
        <h2>Model id</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>When a model&rsquo;s id field has been set then this field is populated. Setting
this field will not change it and will probably break your model</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">id: </span><span class="kc">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Some database systems use a different id field to <code>id</code>. If this is the case
then override it here and that field will be used to give the magic <code>id</code>
field
here</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">idField: </span><span class="s2">&quot;id&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Using_&lt;a_href=&quot;Collection.coffee.html&quot;&gt;Collection&lt;/a&gt;_classes_as_fields'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Using_&lt;a_href=&quot;Collection.coffee.html&quot;&gt;Collection&lt;/a&gt;_classes_as_fields">&#182;</a>
        </div>
        <h2>Using <a href="Collection.coffee.html">Collection</a> classes as fields</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>If you set a field as a Collection then it is handled slightly
differently. As well as the field being set as a Collection instance, the
collection will be added to the <code>@collections</code> object and a
<code>addCollection [key, collection]</code> event is fired.</p>

<p>e.g. if</p>

<pre><code>fields:
    myCollection: Collection
</code></pre>

<p>then</p>

<pre><code>model.set &lsquo;myCollection&rsquo;, [{model}, {model}]
=&gt; model.collections.myCollection = collection
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">collections: </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>If using default <code>Storage</code> class then you can set the server url here. If
the Model was create via a Collection then @url will be read from that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">url: </span><span class="kc">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-Using_the_Model_class'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Using_the_Model_class">&#182;</a>
        </div>
        <h1>Using the Model class</h1>

<p>When instantiating a model often you will be passing it&rsquo;s field values to as
the <code>attributes</code> object, typically after a json response from the server.</p>

<p>e.g.</p>

<pre><code>m = new Model
    id: 5
    text: &ldquo;Hello there everyone&rdquo;
    createdDate: &ldquo;2012/05/15&rdquo;
</code></pre>

<p>Usually a model would be part of a collection and generally instatiated from
there but if that&rsquo;s not the case then you pass in the collection it&rsquo;s part of
directly, and the server resource url too for persistance. Generally the url
would be taken from the associated collection.</p>

<p>When a model is first instatiated no events are fired.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">initialize: </span><span class="nf">(attributes, options={}) -&gt;</span>
        <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
                <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
                <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="nx">@setOptions</span> <span class="nx">options</span>
        <span class="nx">@_setInitial</span> <span class="nx">attributes</span>
        <span class="err">@</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Simple has, get methods</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">has: </span><span class="nf">(key) -&gt;</span>
        <span class="nx">@_attributes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>

    <span class="nv">get: </span><span class="p">(</span><span class="nf">(key) -&gt;</span>
        <span class="nv">_value = </span><span class="nx">@_cloneField</span> <span class="nx">key</span>

        <span class="k">if</span> <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">get</span>
            <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">_value</span>
        <span class="k">else</span>
            <span class="nx">_value</span>

    <span class="p">).</span><span class="nx">overloadGetter</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Set can accept <code>key</code>, <code>value</code> arguments to set one field&rsquo;s value, or it
can accept a key/value object to set multiple at once.</p>

<p>If any fields are defined then the value will be passed to the field class.
If the value is an Collection then it is also added to <code>@collection</code>.</p>

<p>For each field that&rsquo;s updated 2 <code>change</code> events are fired to notify any
listeners, unless <code>silent: true</code> is passed through as an option.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">set: </span><span class="nf">(key, value, options={}) -&gt;</span>

        <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
            <span class="nv">attrs = </span><span class="nx">key</span>
            <span class="nv">options = </span><span class="nx">value</span> <span class="o">or</span> <span class="nx">options</span>
        <span class="k">else</span>
            <span class="nv">attrs = </span><span class="p">{}</span>
            <span class="nx">attrs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

        <span class="nv">_attrs = </span><span class="p">{}</span>
        <span class="k">try</span>
            <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">attrs</span>
                <span class="nx">_attrs</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_set</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">options</span>
        <span class="k">catch</span> <span class="nx">error</span>
            <span class="k">if</span> <span class="nx">instanceOf</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">Exceptions</span><span class="p">.</span><span class="nx">Validation</span>
                <span class="k">return</span> <span class="kc">false</span>

        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">_attrs</span>
            <span class="k">if</span> <span class="nx">@_isCollection</span> <span class="nx">key</span>
                <span class="nx">@_addCollection</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span>

            <span class="nv">curVal = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">encode</span> <span class="nx">@_attributes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
            <span class="nv">newVal = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">encode</span> <span class="nx">value</span>
            <span class="nv">changed = </span><span class="nx">curVal</span> <span class="o">isnt</span> <span class="nx">newVal</span>

            <span class="k">if</span> <span class="o">not</span> <span class="nx">@_dirtyFields</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">changed</span>
                <span class="nx">@_dirtyFields</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_attributes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

            <span class="nx">@_attributes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
            <span class="k">if</span> <span class="nx">key</span> <span class="o">==</span> <span class="nx">@idField</span>
                <span class="vi">@id = </span><span class="nx">value</span>

            <span class="k">if</span> <span class="nx">changed</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span>
                <span class="nx">@fireEvent</span> <span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span>
                <span class="nx">@fireEvent</span> <span class="s2">&quot;change:#{key}&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">value</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">true</span>

    <span class="nv">_set: </span><span class="nf">(key, value, options) -&gt;</span>
        <span class="k">if</span> <span class="nx">@_isCollection</span> <span class="nx">key</span>
            <span class="nv">_value = </span><span class="nx">@_makeCollection</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
        <span class="k">else</span>
            <span class="nv">_value = </span><span class="nx">@_makeValue</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>

        <span class="k">if</span> <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">set</span><span class="o">?</span>
            <span class="nx">@properties</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">_value</span><span class="p">,</span> <span class="nx">value</span>
        <span class="k">else</span>
            <span class="nx">@_validateField</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">_value</span><span class="p">,</span> <span class="nx">options</span>
            <span class="nx">_value</span>

    <span class="nv">_validateField: </span><span class="nf">(key, value, options={}) -&gt;</span>
        <span class="k">if</span> <span class="nx">@validators</span> <span class="o">and</span> <span class="nx">@validators</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
            <span class="nv">result = </span><span class="nx">@validators</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">value</span>
            <span class="k">if</span> <span class="nx">result</span> <span class="o">isnt</span> <span class="kc">true</span>
                <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span>
                    <span class="nx">@fireEvent</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">result</span><span class="p">]</span>
                    <span class="nx">@fireEvent</span> <span class="s2">&quot;error:#{key}&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">value</span><span class="p">,</span> <span class="nx">result</span><span class="p">]</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exceptions</span><span class="p">.</span><span class="nx">Validation</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">result</span>
        <span class="k">return</span> <span class="kc">true</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Whether model is already stored or new</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">isNew: </span><span class="o">-&gt;</span> <span class="o">not</span> <span class="nx">@id</span><span class="o">?</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Whether a model has unsaved changes or not</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">isDirty: </span><span class="o">-&gt;</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">getLength</span><span class="p">(</span><span class="nx">@_dirtyFields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Clear unsaved changes and restores model to last saved state</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">clearChanges: </span><span class="nf">(options={silent: true}) -&gt;</span>
        <span class="nx">@set</span> <span class="nx">@_dirtyFields</span><span class="p">,</span> <span class="nx">options</span>
        <span class="nx">@_clearDirtyFields</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-Serialisation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Serialisation">&#182;</a>
        </div>
        <h2>Serialisation</h2>

<p>This method will return a represenation of the model in a format that
is suitable for JSON encoding. This is used to store the model but is
also very handy for rendering the model in templates etc.</p>

<p>For string or numbers their values do not need any conversion, but for
any custom classes then serialisation of these can be handled in two ways</p>

<ul>
<li><strong>Ensure object has <code>toJSON</code> method</strong></li>
</ul>

<p>Much like Model and Collection have a <code>toJSON</code>, any custom classes you
  use for fields can simply have a <code>toJSON</code> method</p>

<ul>
<li><strong>Specify a custom JSON method</strong></li>
</ul>

<p>Alternatively for a given field <code>myField</code> you can create a method on
  the class called <code>jsonMyField</code> which will be called to serialise the
  data</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">toJSON: </span><span class="o">-&gt;</span>
        <span class="nv">attrs = </span><span class="p">{}</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@_attributes</span>
            <span class="nx">attrs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_jsonKeyValue</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
        <span class="k">return</span> <span class="nx">attrs</span></pre></div>
      </td>
    </tr>
    <tr id='section-Model_storage'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Model_storage">&#182;</a>
        </div>
        <h1>Model storage</h1>

<p>The actual model storage has been abstracted out to
<a href="Storage.coffee.html">Storage</a>
which should be read to learn about the various events fired during each
operation and as well as how to handle to returned promise.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Fetches the model from the server, useful if you just have the id
of the model.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">fetch: </span><span class="nf">(options={}) -&gt;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">@isNew</span><span class="p">()</span>

        <span class="nv">storageOptions = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">merge</span> <span class="p">{</span><span class="nv">eventName: </span><span class="s1">&#39;fetch&#39;</span><span class="p">},</span> <span class="nx">options</span>
        <span class="nv">promise = </span><span class="nx">@storage</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">storageOptions</span>
        <span class="nx">promise</span><span class="p">.</span><span class="k">when</span> <span class="p">(</span><span class="nx">isSuccess</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">isSuccess</span>
                <span class="nx">@set</span> <span class="nx">data</span><span class="p">,</span> <span class="nv">silent: </span><span class="kc">true</span>
                <span class="nx">@_clearDirtyFields</span><span class="p">()</span>
                <span class="nx">@fireEvent</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="p">[</span><span class="kc">true</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Saves the model. Can be called simply as <code>save()</code> to store the model in
its current state or you can specificy only certain values to update and
call <code>save(field, value)</code> or <code>save(fieldValueObject</code> in the same way you
call <code>set</code></p>

<p>By default if any values are specified then when the save operation has
completed then the standard set <code>change</code> events are fired. However if
<code>options.dontWait=true</code> then the <code>change</code> events are fired immediately.
This is for if you are assuming request success rather than waiting for
it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">save: </span><span class="nf">(key, value, options={}) -&gt;</span>
        <span class="nv">ModelClass = </span><span class="nx">@$constructor</span>
        <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
            <span class="nv">attrs = </span><span class="p">{}</span>
            <span class="nx">attrs</span><span class="p">[</span><span class="nx">@idField</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@id</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@isNew</span><span class="p">()</span>
            <span class="nv">toUpdate = </span><span class="k">new</span> <span class="nx">ModelClass</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nv">ignoreDefaults: </span><span class="kc">true</span>
            <span class="nx">toUpdate</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nv">silent: </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
        <span class="k">else</span>
            <span class="nv">toUpdate = </span><span class="k">new</span> <span class="nx">ModelClass</span> <span class="nx">@toJSON</span><span class="p">()</span>

        <span class="nv">data = </span><span class="nx">toUpdate</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
            <span class="nv">options = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

        <span class="nv">setAttrFn = </span><span class="o">=&gt;</span>
            <span class="nx">@set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span> <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
            <span class="nx">@_clearDirtyFields</span><span class="p">()</span>
        <span class="nx">setAttrFn</span><span class="p">()</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dontWait</span>

        <span class="nv">storageMethod = </span><span class="k">if</span> <span class="nx">@isNew</span><span class="p">()</span> <span class="k">then</span> <span class="s2">&quot;create&quot;</span> <span class="k">else</span> <span class="s2">&quot;update&quot;</span>
        <span class="nv">storageOptions = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">merge</span> <span class="p">{</span><span class="nv">eventName: </span><span class="s1">&#39;save&#39;</span><span class="p">},</span> <span class="nx">options</span>
        <span class="nv">promise = </span><span class="nx">@storage</span> <span class="nx">storageMethod</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">storageOptions</span>
        <span class="nx">promise</span><span class="p">.</span><span class="k">when</span> <span class="p">(</span><span class="nx">isSuccess</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">isSuccess</span>
                <span class="nx">setAttrFn</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dontWait</span>
                <span class="nv">model = </span><span class="nx">data</span> <span class="o">or</span> <span class="p">{}</span>
                <span class="nx">@set</span> <span class="nx">model</span><span class="p">,</span> <span class="nv">silent: </span><span class="kc">true</span>
                <span class="nx">@_clearDirtyFields</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>Deletes the model from storage</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">destroy: </span><span class="nf">(options={}) -&gt;</span>
        <span class="nv">fireEvent = </span><span class="o">=&gt;</span>
            <span class="nx">@fireEvent</span> <span class="s1">&#39;destroy&#39;</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span>

        <span class="k">if</span> <span class="nx">@isNew</span><span class="p">()</span>
            <span class="nx">fireEvent</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dontWait</span>
            <span class="nx">fireEvent</span><span class="p">()</span>

        <span class="nv">storageOptions = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">merge</span> <span class="p">{</span><span class="nv">eventName: </span><span class="s1">&#39;destroy&#39;</span><span class="p">},</span> <span class="nx">options</span>
        <span class="nv">promise = </span><span class="nx">@storage</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">storageOptions</span>
        <span class="nx">promise</span><span class="p">.</span><span class="k">when</span> <span class="p">(</span><span class="nx">isSuccess</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">isSuccess</span>
                <span class="nx">fireEvent</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dontWait</span></pre></div>
      </td>
    </tr>
    <tr id='section-Private_methods'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Private_methods">&#182;</a>
        </div>
        <h1>Private methods</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">_attributes: </span><span class="p">{}</span>
    <span class="nv">_dirtyFields: </span><span class="p">{}</span>

    <span class="nv">_makeValue: </span><span class="nf">(key, value) -&gt;</span>
        <span class="nv">type = </span><span class="nx">@_getType</span> <span class="nx">key</span>
        <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="p">(</span><span class="nx">@_makeValue</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">type</span>
            <span class="nx">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="nb">String</span>
            <span class="nb">String</span> <span class="nx">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="nb">Number</span>
            <span class="nb">Number</span><span class="p">.</span><span class="nx">from</span> <span class="nx">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="nb">Date</span>
            <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">and</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isModel</span>
            <span class="nv">value = </span><span class="nx">value</span> <span class="o">or</span> <span class="p">{}</span>
            <span class="nv">val = </span><span class="k">new</span> <span class="nx">type</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
            <span class="nv">val._parent = </span><span class="err">@</span>
            <span class="nx">val</span>
        <span class="k">else</span>
            <span class="k">new</span> <span class="nx">type</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>

    <span class="nv">_getType: </span><span class="nf">(name) -&gt;</span>
        <span class="nv">type = </span><span class="nx">@fields</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span>
            <span class="nx">type</span><span class="p">()</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">==</span>  <span class="s2">&quot;string&quot;</span>
            <span class="nb">window</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span>
        <span class="k">else</span>
            <span class="nx">type</span>

    <span class="nv">_isCollection: </span><span class="nf">(key) -&gt;</span>
        <span class="nv">type = </span><span class="nx">@_getType</span> <span class="nx">key</span>
        <span class="k">return</span> <span class="nx">type</span><span class="o">?</span> <span class="o">and</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">and</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isCollection</span>

    <span class="nv">_isModel: </span><span class="nf">(key) -&gt;</span>
        <span class="nv">type = </span><span class="nx">@_getType</span> <span class="nx">key</span>
        <span class="k">return</span> <span class="nx">type</span><span class="o">?</span> <span class="o">and</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">and</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isModel</span>

    <span class="nv">_makeCollection: </span><span class="nf">(key, value) -&gt;</span>
        <span class="nv">collectionClass = </span><span class="nx">@_getType</span> <span class="nx">key</span>
        <span class="k">new</span> <span class="nx">collectionClass</span> <span class="nx">value</span><span class="p">,</span> <span class="nv">parentModel: </span><span class="k">this</span>

    <span class="nv">_addCollection: </span><span class="nf">(key, collection, options={}) -&gt;</span>
        <span class="nx">@collections</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">collection</span>
        <span class="nx">@fireEvent</span> <span class="s1">&#39;addCollection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">collection</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span>

    <span class="nv">_setInitial: </span><span class="nf">(attributes={}) -&gt;</span>
        <span class="nx">unless</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">ignoreDefaults</span>
            <span class="nv">defaults = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">map</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">@defaults</span><span class="p">)),</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@_getDefault</span> <span class="nx">key</span>
        <span class="k">else</span>
            <span class="nv">defaults = </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Merge defaults into attributes like this to
keep references intact</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nv">attrKeys = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">attributes</span>
        <span class="nv">defaults = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nf">(value, key) -&gt;</span>
            <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">attrKeys</span>

        <span class="nb">Object</span><span class="p">.</span><span class="nx">merge</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">defaults</span>
        <span class="nx">@set</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nv">silent: </span><span class="kc">true</span>
        <span class="nx">@_clearDirtyFields</span><span class="p">()</span>

    <span class="nv">_cloneField: </span><span class="nf">(key) -&gt;</span>
        <span class="nv">value = </span><span class="nx">@_attributes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="nv">type = </span><span class="nx">@_getType</span> <span class="nx">key</span>
        <span class="nv">jsonValue = </span><span class="nx">@_jsonKeyValue</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>

        <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">jsonValue</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="nv">_value = </span><span class="nx">jsonValue</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">jsonValue</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
            <span class="nv">_value = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">jsonValue</span>
        <span class="k">else</span>
            <span class="nv">_value = </span><span class="nx">jsonValue</span>

        <span class="k">if</span> <span class="nx">_value</span> <span class="o">and</span> <span class="nx">@_isCollection</span> <span class="nx">key</span>
            <span class="nv">_value = </span><span class="k">new</span> <span class="nx">type</span> <span class="nx">_value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">_value</span> <span class="o">and</span> <span class="nx">@_isModel</span> <span class="nx">key</span>
            <span class="nv">_value = </span><span class="k">new</span> <span class="nx">type</span> <span class="nx">_value</span>
            <span class="nv">_value._parent = </span><span class="k">this</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span>
            <span class="nv">_value = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">_value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">constructor</span>
            <span class="nv">_value = </span><span class="k">new</span> <span class="nx">value</span><span class="p">.</span><span class="nx">constructor</span> <span class="nx">_value</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="nv">_value = </span><span class="nx">_value</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(item, idx) -&gt;</span>
                <span class="nv">orig = </span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">orig</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span>
                    <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">item</span>
                <span class="k">else</span> <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">orig</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span> <span class="nx">orig</span><span class="p">.</span><span class="nx">constructor</span>
                    <span class="k">new</span> <span class="nx">orig</span><span class="p">.</span><span class="nx">constructor</span> <span class="nx">item</span>
                <span class="k">else</span>
                    <span class="nx">item</span>
        <span class="nx">_value</span>

    <span class="nv">_getDefault: </span><span class="nf">(key) -&gt;</span>
        <span class="nv">def = </span><span class="nx">@defaults</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">def</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
            <span class="nx">def</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
        <span class="k">else</span>
            <span class="nx">def</span>

    <span class="nv">_isSuccess: </span><span class="nf">(response) -&gt;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">success</span> <span class="o">is</span> <span class="kc">true</span>

    <span class="nv">_jsonKeyValue: </span><span class="nf">(key, value) -&gt;</span>
        <span class="nv">jsonFn = </span><span class="s2">&quot;json#{key.capitalize()}&quot;</span>
        <span class="k">if</span> <span class="err">@</span><span class="p">[</span><span class="nx">jsonFn</span><span class="p">]</span><span class="o">?</span>
            <span class="err">@</span><span class="p">[</span><span class="nx">jsonFn</span><span class="p">](</span><span class="nx">value</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="p">(</span><span class="nx">@_jsonValue</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="nx">@_jsonValue</span> <span class="nx">value</span>

    <span class="nv">_jsonValue: </span><span class="nf">(value) -&gt;</span>
        <span class="k">if</span> <span class="nx">value</span> <span class="o">and</span> <span class="nx">instanceOf</span> <span class="nx">value</span><span class="p">,</span> <span class="nb">Date</span>
            <span class="nx">value</span><span class="p">.</span><span class="nx">format</span> <span class="s2">&quot;%Y-%m-%dT%H:%M:%S.%LZ&quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">and</span> <span class="nx">typeOf</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
            <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
        <span class="k">else</span>
            <span class="nx">value</span>

    <span class="nv">_clearDirtyFields: </span><span class="o">-&gt;</span>
        <span class="vi">@_dirtyFields = </span><span class="p">{}</span>

    <span class="nv">isModel: </span><span class="kc">true</span>

<span class="k">return</span> <span class="nx">Model</span>
<span class="o">`</span><span class="p">});</span><span class="o">`</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
