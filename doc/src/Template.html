<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Template.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="Collection.html">Collection.coffee</a>
          <a class="source" href="Exceptions.html">Exceptions.coffee</a>
          <a class="source" href="Model.html">Model.coffee</a>
          <a class="source" href="Router.html">Router.coffee</a>
          <a class="source" href="Storage.html">Storage.coffee</a>
          <a class="source" href="Template.html">Template.coffee</a>
          <a class="source" href="View.html">View.coffee</a>
          <a class="source" href="Views.html">Views.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>Template.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Provides rendering of dust.js templates as well as simple node reference
tracking and event delegation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">define</span> <span class="o">-&gt;</span> <span class="o">\</span>

<span class="k">new</span> <span class="nx">Class</span>
    <span class="nv">TEMPLATES: </span><span class="p">{}</span>
    <span class="nv">refs: </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Template_Rendering'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Template_Rendering">&#182;</a>
        </div>
        <h1>Template Rendering</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Renders a dust.js template and returns the html nodes. It does not insert
these into the DOM.</p>

<ul>
<li><p><code>templateName</code></p>

<p>Name of dust template to use. Dust templates have to be loaded before
the are used, but this will try to load it if it hasn&rsquo;t already. If
however the template uses partials then you need to make sure that
these have all been loaded &ndash; see <code>loadAllTemplates</code>.</p></li>
<li><p><code>data</code></p>

<p>Data object to be passed into dust template.</p></li>
<li><p><code>events</code></p>

<p>Any events passed in will be delegated from the top-level node(s) &ndash;
see <code>delegateEvents</code> for syntax.</p></li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">renderTemplate: </span><span class="nf">(templateName, data={}, events=null) -&gt;</span>
        <span class="nv">rendered = </span><span class="nx">@_renderDustTemplate</span> <span class="nx">templateName</span><span class="p">,</span> <span class="nx">data</span>
        <span class="nv">els = </span><span class="nx">Elements</span><span class="p">.</span><span class="nx">from</span> <span class="nx">rendered</span>
        <span class="nx">@delegateEvents</span> <span class="nx">els</span><span class="p">,</span> <span class="nx">events</span> <span class="k">if</span> <span class="nx">events</span><span class="o">?</span>

        <span class="k">if</span> <span class="nx">els</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="nx">els</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span>
            <span class="nx">els</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Loads all current dust templates into memory so they can be rendered.
This step is essential if partials are used anywhere as they are
expected to be in the dust cache already when called.</p>

<p>Templates are loaded from either:</p>

<ul>
<li><code>@TEMPLATES</code> object in this class.</li>
</ul>

<p>e.g.</p>

<pre><code>      TEMPLATES:
          &ldquo;templateName&rdquo;: &ldquo;&rdquo;&ldquo;
          &lt;body&gt;
              &lt;p&gt;Some elements&lt;/p&gt;
          &lt;/body&gt;
          &rdquo;&ldquo;&rdquo;
</code></pre>

<ul>
<li>Any script tags in the current HTML.</li>
</ul>

<p>e.g.</p>

<pre><code>      &lt;script template=&ldquo;templateName&rdquo; type=&ldquo;text/html&rdquo;&gt;
      &lt;body&gt;
          &lt;p&gt;I am the internet&lt;/p&gt;
      &lt;/body&gt;
      &lt;/script&gt;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">loadAllTemplates: </span><span class="o">-&gt;</span>
        <span class="nx">@_loadTemplate</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">@TEMPLATES</span>
        <span class="nx">@_loadTemplate</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">$$</span><span class="p">(</span><span class="s">&#39;script[type=text/html]&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;template&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Delegates events from the top level node(s) of the passed in <code>els</code>.</p>

<p>The <code>events</code> object is of the following syntax</p>

<pre><code>&ldquo;eventType:cssSelector&rdquo;: &ldquo;functionName&rdquo;
</code></pre>

<p>e.g.</p>

<pre><code>&ldquo;click:div.close&rdquo;: &ldquo;close&rdquo;
&ldquo;click:div.delete&rdquo;: &ldquo;delete&rdquo;
</code></pre>

<p>You can chose to stop event propagation upwards and the default action
of the elements by default if you wish.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">delegateEvents: </span><span class="nf">(els, events, stopPropagation=false,</span>
<span class="nf">            preventDefault=false) -&gt;</span>

        <span class="nv">els = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">from</span> <span class="nx">els</span>
        <span class="k">for</span> <span class="nx">eventKey</span><span class="p">,</span> <span class="nx">fnName</span> <span class="k">of</span> <span class="nx">events</span>
            <span class="nv">boundFn = </span><span class="nf">(fnName, event, target) -&gt;</span>
                <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">()</span> <span class="k">if</span> <span class="nx">stopPropagation</span>
                <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span> <span class="k">if</span> <span class="nx">preventDefault</span>
                <span class="nx">@</span><span class="p">[</span><span class="nx">fnName</span><span class="p">]</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">target</span>
            <span class="nv">boundFn = </span><span class="nx">boundFn</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">fnName</span>
            <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">els</span>
                <span class="nx">@_addDelegatedEvent</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventKey</span><span class="p">,</span> <span class="nx">boundFn</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>To make saving references to elements with the template easier, if you
add the property ref to the element. Running this will then pull those
references back into an object.</p>

<p>e.g.</p>

<pre><code>    &lt;div&gt;
        &lt;a href=&ldquo;/somewhere&rdquo; ref=&ldquo;link&rdquo;&gt;Link&lt;/a&gt;
        &lt;div ref=&ldquo;title&rdquo;&gt;Title&lt;/div&gt;
    &lt;/div&gt;
</code></pre>

<p>results in</p>

<pre><code>    link: &lt;reference to a Element&gt;
    title: &lt;reference to div Element&gt;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">getRefs: </span><span class="nf">(els, ref=null) -&gt;</span>
        <span class="nv">refs = </span><span class="p">{}</span>
        <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">from</span> <span class="nx">els</span>
            <span class="nv">elRefName = </span><span class="nx">el</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;ref&#39;</span>
            <span class="k">return</span> <span class="nx">el</span> <span class="k">if</span> <span class="nx">ref</span> <span class="o">and</span> <span class="nx">elRefName</span> <span class="o">==</span> <span class="nx">ref</span>
            <span class="nx">refs</span><span class="p">[</span><span class="nx">elRefName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">el</span> <span class="k">if</span> <span class="nx">elRefName</span>

            <span class="k">for</span> <span class="nx">refEl</span> <span class="k">in</span> <span class="nx">el</span><span class="p">.</span><span class="nx">getElements</span> <span class="s">&quot;*[ref]&quot;</span>
                <span class="nv">refName = </span><span class="nx">refEl</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;ref&#39;</span>
                <span class="k">return</span> <span class="nx">refEl</span> <span class="k">if</span> <span class="nx">ref</span> <span class="o">and</span> <span class="nx">refName</span> <span class="o">==</span> <span class="nx">ref</span>

                <span class="nx">refs</span><span class="p">[</span><span class="nx">refName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">refEl</span>

        <span class="k">return</span> <span class="nx">refs</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Pulls out a given ref, calls getRefs directly so just gives a more
meaningful name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">getRef: </span><span class="nf">(el, ref) -&gt;</span> <span class="nx">@getRefs</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">ref</span></pre></div>
      </td>
    </tr>
    <tr id='section-Private_methods'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Private_methods">&#182;</a>
        </div>
        <h1>Private methods</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Calls dust to render the given template. It will try to load the template
before rendering.</p>

<p>To allow for setting variables it adds the variable <code>let</code> to the context
and points it to the root so that the context with <code>let</code> is effectively
unchanged. This means you can do the following to override a variable
with a <code>#let</code> statement</p>

<pre><code>{#let var1=&ldquo;value&rdquo; var2=&ldquo;value&rdquo;}
{/let}
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">_renderDustTemplate: </span><span class="nf">(templateName, data={}) -&gt;</span>
        <span class="nx">@_loadTemplate</span> <span class="nx">templateName</span>
        <span class="nv">data = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">data</span>
        <span class="nv">data.let = </span><span class="nx">data</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">data.iter = </span><span class="nf">(chk, ctx, bodies) -&gt;</span>
            <span class="nv">obj = </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span>
            <span class="k">for</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">obj</span>
                <span class="nv">chk = </span><span class="nx">chk</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">bodies</span><span class="p">.</span><span class="nx">block</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nv">key: </span><span class="nx">r</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">k</span><span class="p">}))</span>
            <span class="nx">chk</span>
        <span class="nv">rendered = </span><span class="s">&quot;&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>add custom filter to capitalise strings in dust</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nv">dust.filters.c = </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">capitalize</span><span class="p">()</span>
        <span class="nx">dust</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">templateName</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(err, out) -&gt;</span>
            <span class="nv">rendered = </span><span class="nx">out</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nx">rendered</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Tries to find and load a dustjs template if it is not already in the
cache</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">_loadTemplate: </span><span class="nf">(templateName) -&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">dust</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">templateName</span><span class="p">]</span><span class="o">?</span>
            <span class="nv">compiled = </span><span class="nx">dust</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">@_getTemplate</span><span class="p">(</span><span class="nx">templateName</span><span class="p">),</span> <span class="nx">templateName</span>
            <span class="nx">dust</span><span class="p">.</span><span class="nx">loadSource</span> <span class="nx">compiled</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Tries to find template in the following order of precedence:</p>

<p>1 &ndash; Within the current class in <code>@TEMPLATES</code></p>

<p>2 &ndash; Within a JST script tag on the page</p>

<pre><code>    &lt;script type=&ldquo;text/html&rdquo; template=&ldquo;template-name&rdquo;&gt;
    &lt;div&gt;{{somestuff}}&lt;/div&gt;
    &lt;/script&gt;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">_getTemplate: </span><span class="nf">(templateName) -&gt;</span>
        <span class="nv">template = </span><span class="nx">@TEMPLATES</span><span class="p">[</span><span class="nx">templateName</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@TEMPLATES</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">template</span> <span class="k">if</span> <span class="nx">template</span><span class="o">?</span>
        <span class="nv">template = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElement</span> <span class="s">&quot;script[template=</span><span class="si">#{</span><span class="nx">templateName</span><span class="si">}</span><span class="s">]&quot;</span>
        <span class="k">return</span> <span class="nx">template</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;html&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">template</span><span class="o">?</span>
        <span class="k">throw</span> <span class="s">&quot;Cannot find template </span><span class="si">#{</span><span class="nx">templateName</span><span class="si">}</span><span class="s">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Delegates an event from a given element.</p>

<p>Mootools uses a more verbose syntax to specify the event.</p>

<p>e.g</p>

<pre><code>&ldquo;click:a.close&rdquo;
</code></pre>

<p>in converted to</p>

<pre><code>&ldquo;click:relay(a.close)&rdquo;
</code></pre>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">_addDelegatedEvent: </span><span class="nf">(el, eventKey, fn) -&gt;</span>
        <span class="nv">eventKey = </span><span class="nx">eventKey</span><span class="p">.</span><span class="nx">split</span> <span class="s">&quot;:&quot;</span>
        <span class="nv">mtEvent = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">eventKey</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">:relay(</span><span class="si">#{</span><span class="nx">eventKey</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">)&quot;</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">addEvent</span> <span class="nx">mtEvent</span><span class="p">,</span> <span class="nx">fn</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
