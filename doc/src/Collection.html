<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Collection.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="Collection.html">Collection.coffee</a>
          <a class="source" href="Events.html">Events.coffee</a>
          <a class="source" href="Exceptions.html">Exceptions.coffee</a>
          <a class="source" href="Model.html">Model.coffee</a>
          <a class="source" href="Router.html">Router.coffee</a>
          <a class="source" href="Storage.html">Storage.coffee</a>
          <a class="source" href="Template.html">Template.coffee</a>
          <a class="source" href="View.html">View.coffee</a>
          <a class="source" href="Views.html">Views.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>Collection.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Provides a simple collection class, which can be used to handle retrieval
and management of sets of <a href="Model.coffee.html">Model</a>s</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">define</span> <span class="o">[</span><span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;bags/Storage&#39;</span><span class="p">,</span> <span class="s1">&#39;bags/Events&#39;</span><span class="o">]</span><span class="p">,</span> <span class="p">(</span><span class="nb">require</span><span class="p">,</span> <span class="no">Storage</span><span class="p">,</span> <span class="no">Events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">\</span>

<span class="kp">new</span> <span class="no">Class</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Extends the native javascript Array object so we get all the methods of
this class as well as the Mootools extensions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="no">Extends</span><span class="p">:</span> <span class="nb">Array</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Uses <a href="Storage.coffee.html">Storage</a> for collection retrieval</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="no">Implements</span><span class="p">:</span> <span class="o">[</span><span class="no">Options</span><span class="p">,</span> <span class="no">Events</span><span class="p">,</span> <span class="no">Storage</span><span class="o">]</span>

    <span class="n">options</span><span class="p">:</span> <span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>If using a custom Model then it needs to set here, as this class will
be used to create new instances after calling <code>fetch</code>
model: Model</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>If using default <code>Storage</code> class then you must set the URL here</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">url</span><span class="p">:</span> <span class="n">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-Using_the_Collection_class'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Using_the_Collection_class">&#182;</a>
        </div>
        <h1>Using the Collection class</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>You can initialise the collection with a set of existing models,
e.g. if you bootstrap.</p>

<p>If you want to set <code>@url</code> or <code>@model</code> on init then these can be passed in
as <code>options</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">initialize</span><span class="p">:</span> <span class="p">(</span><span class="n">models</span><span class="o">=[]</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">parentModel?</span>
            <span class="vi">@parentModel</span> <span class="o">=</span>
                <span class="nb">id</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">parentModel</span><span class="o">.</span><span class="n">id</span>
                <span class="n">klass</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">parentModel</span><span class="o">.</span><span class="n">constructor</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Can&rsquo;t store actual instance otherwise browswers crash
in some instances presumabley down to a circular reference</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">delete</span> <span class="n">options</span><span class="o">.</span><span class="n">parentModel</span>

        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="o">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;sortField&#39;</span><span class="o">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">?</span>
                <span class="err">@</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
                <span class="n">delete</span> <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
        <span class="vi">@setOptions</span> <span class="n">options</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="vi">@model</span>
            <span class="vi">@model</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;bags/Model&#39;</span>

        <span class="vi">@add</span> <span class="n">models</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="kp">true</span>
        <span class="err">@</span></pre></div>
      </td>
    </tr>
    <tr id='section-Collection_retrieval'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Collection_retrieval">&#182;</a>
        </div>
        <h2>Collection retrieval</h2>

<p>The actual collection storage has been abstracted out to
<a href="Storage.coffee.html">Storage</a>
which should be read to learn about the various events fired during each
operation and as well as how to handle to returned promise.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Use this method to fetch a collectin of models from the server.</p>

<p>By default this will replace the current collection with the retrieved
collection by calling <code>@reset</code>.</p>

<p>If you wish to add to the collection rather than replace it then set
<code>options.add=true</code> and <code>@add</code> will be called instead</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">fetch</span><span class="p">:</span> <span class="p">(</span><span class="n">filter</span><span class="o">=</span><span class="p">{},</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="n">promise</span> <span class="o">=</span> <span class="vi">@storage</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">filter</span>
        <span class="n">promise</span><span class="o">.</span><span class="n">when</span> <span class="p">(</span><span class="n">isSuccess</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="n">isSuccess</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">add</span>
                    <span class="vi">@add</span> <span class="n">models</span><span class="p">,</span> <span class="n">options</span>
                <span class="k">else</span>
                    <span class="vi">@reset</span> <span class="n">models</span><span class="p">,</span> <span class="n">options</span>
                <span class="vi">@fireEvent</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="o">[</span><span class="kp">true</span><span class="o">]</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>This will replace the current collection with the models that are passed
in, and fires a <code>reset</code> event at the end.</p>

<p>If you call this without any options it will just empty the collection.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">reset</span><span class="p">:</span> <span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="vi">@_remove</span> <span class="n">model</span><span class="p">,</span> <span class="n">options</span> <span class="k">while</span> <span class="n">model</span> <span class="o">=</span> <span class="vi">@pop</span><span class="p">()</span>
        <span class="vi">@add</span> <span class="n">models</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">models?</span>
        <span class="vi">@fireEvent</span> <span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="o">[</span><span class="err">@</span><span class="o">]</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Call to add a model or an array of models to the collection
Fires an <code>add(model)</code> event</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">add</span><span class="p">:</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="vi">@model</span><span class="p">?</span> <span class="k">then</span> <span class="kp">throw</span> <span class="kp">new</span> <span class="no">Error</span> <span class="s2">&quot;Model not defined for collection&quot;</span>

        <span class="k">if</span> <span class="n">typeOf</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span>
            <span class="n">added</span> <span class="o">=</span> <span class="vi">@_add</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="n">model</span>
        <span class="k">else</span>
            <span class="n">added</span> <span class="o">=</span> <span class="vi">@_add</span> <span class="n">model</span><span class="p">,</span> <span class="n">options</span>

        <span class="vi">@sortBy</span> <span class="vi">@sortField</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="kp">true</span> <span class="k">if</span> <span class="vi">@sortField</span><span class="p">?</span>

        <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>
            <span class="vi">@fireEvent</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="o">[</span><span class="n">model</span><span class="o">]</span> <span class="k">for</span> <span class="n">model</span> <span class="k">in</span> <span class="nb">Array</span><span class="o">.</span><span class="n">from</span> <span class="n">added</span>

    <span class="n">_add</span><span class="p">:</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="vi">@_makeModel</span> <span class="n">model</span>
        <span class="vi">@push</span> <span class="n">model</span>
        <span class="n">model</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Provides a shortcut to create a new model in the collection</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">create</span><span class="p">:</span> <span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="vi">@_makeModel</span> <span class="n">attributes</span>
        <span class="vi">@add</span> <span class="n">model</span><span class="p">,</span> <span class="n">options</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Get model with field matching value</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">get</span><span class="p">:</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">this</span>
            <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Sorts the collection like a normal array but also fires a <code>sort</code> event</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">sort</span><span class="p">:</span> <span class="p">(</span><span class="n">comparator</span><span class="o">=</span><span class="vi">@comparator</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="vi">@parent</span> <span class="n">comparator</span>
        <span class="vi">@fireEvent</span> <span class="s1">&#39;sort&#39;</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>

    <span class="n">sortBy</span><span class="p">:</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="vi">@sort</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">aVal</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span> <span class="n">field</span>
            <span class="n">bVal</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span> <span class="n">field</span>
            <span class="n">type</span> <span class="o">=</span> <span class="n">typeOf</span> <span class="n">aVal</span>
            <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span>
                <span class="n">aVal</span> <span class="o">-</span> <span class="n">bVal</span>
            <span class="k">else</span> <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span>
                <span class="n">aVal</span><span class="o">.</span><span class="n">toLowerCase</span><span class="p">()</span><span class="o">.</span><span class="n">localeCompare</span> <span class="n">bVal</span><span class="o">.</span><span class="n">toLowerCase</span><span class="p">()</span>
            <span class="k">else</span> <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span>
                <span class="n">bVal</span><span class="o">.</span><span class="n">diff</span> <span class="n">aVal</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span>
        <span class="p">,</span> <span class="n">options</span>

    <span class="n">sortField</span><span class="p">:</span> <span class="n">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Set this to define a custom comparator for the <code>sort</code> function</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">comparator</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Returns a JSON ready representation of the Collection. See
<a href="Model.coffee.html">Model</a> for more information.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">toJSON</span><span class="p">:</span> <span class="o">-&gt;</span>
        <span class="vi">@invoke</span> <span class="s1">&#39;toJSON&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Private_methods'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Private_methods">&#182;</a>
        </div>
        <h1>Private methods</h1>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">_makeModel</span><span class="p">:</span> <span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instanceOf</span> <span class="n">model</span><span class="p">,</span> <span class="vi">@model</span>
            <span class="n">model</span> <span class="o">=</span> <span class="kp">new</span> <span class="vi">@model</span> <span class="n">model</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="n">this</span>
        <span class="k">else</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">collection?</span>
            <span class="n">model</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">this</span>
        <span class="n">model</span><span class="o">.</span><span class="n">addEvents</span>
            <span class="n">destroy</span><span class="p">:</span> <span class="o">=&gt;</span>
                <span class="vi">@erase</span> <span class="n">model</span>
                <span class="vi">@fireEvent</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="o">[</span><span class="n">model</span><span class="o">]</span>
        <span class="n">model</span>

    <span class="n">_remove</span><span class="p">:</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">removeEvents</span> <span class="s1">&#39;destroy&#39;</span>
        <span class="vi">@erase</span> <span class="n">model</span>
        <span class="vi">@fireEvent</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="o">[</span><span class="n">model</span><span class="o">]</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>

    <span class="n">isCollection</span><span class="p">:</span> <span class="kp">true</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
